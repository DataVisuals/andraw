<app-system-banner></app-system-banner>
<div class="container-fluid">
  <!-- Header -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" routerLink="/">
        <img src="/logo.svg" alt="StoreFront" height="60">
      </a>
      <div class="d-flex align-items-center gap-3">
        <!-- Country Selector -->
        <div class="dropdown">
          <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="countryDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            <span>{{ i18nService.getCurrentCountry().flag }} {{ i18nService.getCurrentCountry().name }}</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="countryDropdown">
            <li *ngFor="let country of countries">
              <a class="dropdown-item" href="javascript:void(0)" (click)="selectCountry(country.code)">
                <span>{{ country.flag }} {{ country.name }}</span>
                <small class="text-muted ms-2">({{ country.currencySymbol }})</small>
              </a>
            </li>
          </ul>
        </div>

        <a routerLink="/cart" class="btn btn-outline-light btn-sm position-relative">
          <i class="bi bi-cart3"></i> Cart
          <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" *ngIf="(cartService.cart$ | async)?.length">
            {{ cartService.getItemCount() }}
          </span>
        </a>
      </div>
    </div>
  </nav>

  <!-- Search and Filters -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body p-3">
          <div class="row g-2 align-items-end">
            <!-- Search -->
            <div class="col-md-4 col-lg-3">
              <div class="input-group input-group-sm">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Search products..."
                  [(ngModel)]="searchTerm"
                  (keyup.enter)="onSearch()">
                <button class="btn btn-primary btn-sm" (click)="onSearch()">
                  <i class="bi bi-search"></i>
                </button>
              </div>
            </div>

            <!-- Category Filter -->
            <div class="col-md-3 col-lg-2">
              <select class="form-select form-select-sm" [(ngModel)]="selectedCategory" (change)="onCategoryChange()">
                <option value="">All Categories</option>
                <option *ngFor="let category of categories" [value]="category">{{ category }}</option>
              </select>
            </div>

            <!-- Price Range -->
            <div class="col-md-2 col-lg-2">
              <input
                type="number"
                class="form-control form-control-sm"
                [placeholder]="'Min ' + i18nService.getCurrentCountry().currencySymbol"
                [(ngModel)]="minPrice"
                (change)="onPriceFilter()">
            </div>

            <div class="col-md-2 col-lg-2">
              <input
                type="number"
                class="form-control form-control-sm"
                [placeholder]="'Max ' + i18nService.getCurrentCountry().currencySymbol"
                [(ngModel)]="maxPrice"
                (change)="onPriceFilter()">
            </div>

            <!-- Advanced Filters Toggle -->
            <div class="col-md-6 col-lg-2">
              <button
                class="btn btn-outline-secondary btn-sm w-100"
                (click)="showAdvancedFilters = !showAdvancedFilters">
                <i class="bi" [ngClass]="showAdvancedFilters ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
                {{ showAdvancedFilters ? 'Less' : 'More' }} Filters
              </button>
            </div>

            <!-- Clear Filters -->
            <div class="col-md-6 col-lg-1">
              <button class="btn btn-outline-danger btn-sm w-100" (click)="clearFilters()">
                <i class="bi bi-x-circle"></i> Clear
              </button>
            </div>
          </div>

          <!-- Advanced Filters Row (Collapsible) -->
          <div class="row g-2 mt-2 advanced-filters" *ngIf="showAdvancedFilters">
            <div class="col-12">
              <hr class="my-2">
            </div>

            <!-- Stock Availability -->
            <div class="col-md-4">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="inStockOnly"
                  [(ngModel)]="inStockOnly"
                  (change)="onPriceFilter()">
                <label class="form-check-label small" for="inStockOnly">
                  <i class="bi bi-check-circle text-success"></i> In Stock Only
                </label>
              </div>
            </div>

            <!-- Max Delivery Days -->
            <div class="col-md-4">
              <select class="form-select form-select-sm" [(ngModel)]="maxDeliveryDays" (change)="onPriceFilter()">
                <option [ngValue]="undefined">Any Delivery Time</option>
                <option [ngValue]="1">1 day delivery</option>
                <option [ngValue]="2">2 days delivery</option>
                <option [ngValue]="3">3 days delivery</option>
                <option [ngValue]="5">5 days delivery</option>
                <option [ngValue]="7">1 week delivery</option>
              </select>
            </div>

            <!-- Minimum Rating -->
            <div class="col-md-4">
              <select class="form-select form-select-sm" [(ngModel)]="minRating" (change)="onPriceFilter()">
                <option [ngValue]="undefined">Any Rating</option>
                <option [ngValue]="4">⭐ 4+ stars</option>
                <option [ngValue]="3">⭐ 3+ stars</option>
                <option [ngValue]="2">⭐ 2+ stars</option>
                <option [ngValue]="1">⭐ 1+ star</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Summary -->
  <div class="row mb-3">
    <div class="col-12">
      <p class="text-muted">
        Showing {{ products.length }} of {{ totalProducts }} products
        <span *ngIf="selectedCategory"> in {{ selectedCategory }}</span>
      </p>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="loading" class="text-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Products Grid -->
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4 mb-4" *ngIf="!loading">
    <div class="col" *ngFor="let product of products">
      <div class="card h-100 shadow-sm product-card">
        <img [src]="product.image_url" class="card-img-top" [alt]="product.name" style="height: 200px; object-fit: cover;">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">
            <a [routerLink]="['/product', product.id]" class="text-decoration-none text-dark">
              {{ product.name }}
            </a>
          </h5>
          <p class="card-text text-muted small flex-grow-1">
            {{ product.description.substring(0, 100) }}{{ product.description.length > 100 ? '...' : '' }}
          </p>

          <!-- Rating -->
          <div class="mb-2">
            <span *ngFor="let filled of getStarArray(product.rating)" class="text-warning">
              <i [class]="filled ? 'bi bi-star-fill' : 'bi bi-star'"></i>
            </span>
            <small class="text-muted ms-1">({{ product.review_count }})</small>
          </div>

          <!-- Price and Stock -->
          <div class="mb-2">
            <h4 class="text-primary mb-0">{{ i18nService.formatPrice(product.price, convertPrice(product.price)) }}</h4>
            <small class="text-success" *ngIf="product.stock_quantity > 0">
              In Stock ({{ product.stock_quantity }} available)
            </small>
            <small class="text-danger" *ngIf="product.stock_quantity === 0">
              Out of Stock
            </small>
          </div>

          <!-- Lead Time -->
          <small class="text-muted mb-3">
            <i class="bi bi-truck"></i> Delivery in {{ product.lead_time_days }} day{{ product.lead_time_days !== 1 ? 's' : '' }}
          </small>

          <!-- Actions -->
          <div class="mt-auto">
            <div class="d-grid gap-2">
              <button
                class="btn btn-primary"
                (click)="addToCart(product)"
                [disabled]="product.stock_quantity === 0">
                <i class="bi bi-cart-plus"></i> Add to Cart
              </button>
              <a [routerLink]="['/product', product.id]" class="btn btn-outline-primary">
                View Details
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- No Results -->
  <div *ngIf="!loading && products.length === 0" class="text-center my-5">
    <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
    <h3 class="mt-3">No products found</h3>
    <p class="text-muted">Try adjusting your search or filters</p>
    <button class="btn btn-primary" (click)="clearFilters()">Clear Filters</button>
  </div>

  <!-- Pagination -->
  <div class="row mb-4" *ngIf="!loading && products.length > 0">
    <div class="col-12">
      <nav>
        <ul class="pagination justify-content-center">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <button class="page-link" (click)="previousPage()" [disabled]="currentPage === 1">
              Previous
            </button>
          </li>
          <li class="page-item active">
            <span class="page-link">
              Page {{ currentPage }} of {{ totalPages }}
            </span>
          </li>
          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <button class="page-link" (click)="nextPage()" [disabled]="currentPage === totalPages">
              Next
            </button>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</div>
